<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Desaf√≠os Din√°micos v8.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* --- KEYFRAMES --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 50%, 90% { transform: translateX(-5px); } 30%, 70% { transform: translateX(5px); } }
        @keyframes floatUpFadeOut {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); }
        }
        @keyframes dropIn {
            from { opacity: 0; transform: translateY(-100px) scale(0.8); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes streak-pop {
            0% { transform: scale(0.5) rotate(-15deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* --- COMPONENT STYLES --- */
        button:disabled, input:disabled { cursor: not-allowed; opacity: 0.6; }
        #app-container > div { animation: fadeIn 0.5s ease-in-out forwards; }

        /* --- STREAK & FEEDBACK --- */
        .points-feedback-animate { animation: floatUpFadeOut 1.5s ease-out forwards; }
        .feedback-incorrect { animation: shake 0.5s ease-in-out; }
        #streak-display.visible { animation: streak-pop 0.5s ease-out forwards; opacity: 1 !important; }

        /* --- CARD STYLES --- */
        .challenge-card { 
            perspective: 1000px;
            transition: all 0.3s ease;
            min-height: 220px;
        }
        .challenge-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 20px 25px -5px rgba(34, 211, 238, 0.2), 0 10px 10px -5px rgba(34, 211, 238, 0.1);
        }
        .challenge-card-inner {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-style: preserve-3d;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* --- GAME & PODIUM --- */
        .option-button.correct { background-color: #22c55e !important; border-color: #16a34a !important; color: white !important; transform: scale(1.05); }
        .option-button.incorrect { background-color: #ef4444 !important; border-color: #dc2626 !important; color: white !important; }
        .option-button:active { transform: scale(0.97); transition-duration: 0.1s; }
        .timer-bar-container { background-color: #374151; border-radius: 8px; overflow: hidden; }
        .timer-bar { height: 8px; background-color: #22d3ee; }
        .podium-item { opacity: 0; /* Start hidden for animation */ }
        .podium-item.second { animation: dropIn 0.5s ease-out 0.2s forwards; }
        .podium-item.first { animation: dropIn 0.5s ease-out 0.4s forwards; }
        .podium-item.third { animation: dropIn 0.5s ease-out 0.6s forwards; }

        /* --- PROFILE & MISC --- */
        .certificate-gallery-item { transition: transform 0.2s; }
        .certificate-gallery-item:hover { transform: scale(1.05); }
        .avatar-selector { cursor: pointer; border: 2px solid transparent; transition: all 0.2s; border-radius: 50%; padding: 4px; }
        .avatar-selector.selected { border-color: #22d3ee; background-color: rgba(34, 211, 238, 0.2); }
        .color-selector { cursor: pointer; width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent; transition: all 0.2s; }
        .color-selector.selected { border-color: white; transform: scale(1.2); }

        /* --- OVERLAYS & FIXED ELEMENTS --- */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        #achievement-unlocked { position: fixed; bottom: -150px; left: 50%; transform: translateX(-50%); transition: bottom 0.5s ease-in-out; z-index: 200; }
        #achievement-unlocked.show { bottom: 20px; }
        #sound-toggle-button {
            position: fixed; top: 1rem; right: 1rem; z-index: 1000;
            background-color: rgba(31, 41, 55, 0.7); backdrop-filter: blur(5px);
            border-radius: 50%; width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
            color: white; transition: all 0.2s ease;
        }
        #sound-toggle-button:hover { background-color: rgba(55, 65, 81, 0.9); transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 overflow-hidden">

    <div id="app-container" class="w-full h-full flex items-center justify-center"></div>
    <canvas id="confetti-canvas"></canvas>
    <div id="achievement-unlocked" class="bg-gray-800 border-2 border-amber-400 p-4 rounded-lg shadow-2xl flex items-center gap-4">
        <div id="achievement-emoji" class="text-4xl"></div>
        <div>
            <p class="text-amber-400 font-bold">¬°Logro Desbloqueado!</p>
            <p id="achievement-name" class="text-white"></p>
        </div>
    </div>

    <button id="sound-toggle-button" title="Activar/Desactivar Sonido"></button>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, getDocs, orderBy, where, Timestamp, writeBatch, serverTimestamp, addDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBzDj23rjeO4nQYOU-beGC7aPomfx1krCo",
          authDomain: "juego-desafios.firebaseapp.com",
          projectId: "juego-desafios",
          storageBucket: "juego-desafios.firebasestorage.app",
          messagingSenderId: "513414920689",
          appId: "1:513414920689:web:55b5b57ff8c7f53a78ec50",
          measurementId: "G-DLMT00D4QF"
        };
        
        const appId = firebaseConfig.projectId;
        
        // --- CONSTANTS ---
        const AVATARS = ['üë©‚ÄçüöÄ', 'üë®‚Äçüî¨', 'üë©‚Äçüé®', 'üë®‚Äçüíª', 'üë©‚Äç‚úàÔ∏è', 'üë®‚Äçüè´', 'üë©‚Äçüé§', 'üë®‚Äçüç≥', 'üë©‚Äçüéì', 'üë®‚Äç‚öñÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üë®‚Äçüöí', 'üë∑‚Äç‚ôÄÔ∏è', 'üë∑‚Äç‚ôÇÔ∏è', 'üë©‚Äçüíº', 'üë®‚Äçüíº', 'üë©‚Äçüîß', 'üë®‚Äçüîß', 'üïµÔ∏è‚Äç‚ôÄÔ∏è', 'üïµÔ∏è‚Äç‚ôÇÔ∏è', 'üëÆ‚Äç‚ôÄÔ∏è', 'üëÆ‚Äç‚ôÇÔ∏è'];
        const COLORS = ['#34d399', '#fbbf24', '#60a5fa', '#f87171', '#a78bfa', '#a3e635', '#22d3ee', '#f472b6'];
        const TIME_PER_QUESTION = 15;
        const REDUCED_TIME_PER_QUESTION = 10;
        const LOGO_URL_WEB = 'logoblanco.png'; 
        const LOGO_URL_CERTIFICATE = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAZlBMVEX///8AAAD8/Pw4ODj39/fR0dFKSkpwcHAvLy/a2trr6+vl5eXW1tZfX1/j4+OgoKBoZ2fExMQYGBh6enpdXV0gICCfn59PT08LCwtubm5ISEgoKCgNDQ0zMzNUVFRfX19JSUk9PT3e82b7AAACFklEQVR4nO3dC3KaQBSG4UzCEsQQRVFBEOr7v6/tUNo0jLALzJn7S35v5kpIc3OFBAKBQCAQCAQCgUAgEAgEAoGgVWK1jB928b/y/h3fC3+1U/C/KkYj3N2zR8yNfT+7eB/fB8vL+B62+L/z/fHl/c56bYLb5eX9g2f2uG3+s3W01O/dM/v8P080L/f5eb/+P6WpS992z+x/z+d/muhW6k+/d8/sE/n8b2hqv3fP7F/y+d/QzJ2+fM+emc3k8++QzD3/7H1vnlrPzD03s08M/vS/t+3t/d/RzD0z98/dM0s694z+zT/L539HMvR/13D0z98/QzL2/k/2eT7/L089/6+TzX/729rTzP2/yef7/vY2NfP/c/bMzn9DM/f/M/sM/6eGaf7/7J2d/oZm7v9t9r/116mmnf1/Zp/I539DM/8f/Zt7Zu6/oZn9if7PP/+tT00z+7/L2T2AQCgUAgEAgEAoFAIBAIBAKB0E/j/26v+B8y/1fOf+V/pC9+N/5/X4J/Z/9rN+D/z9/e/p0S/k9/a/snNP5PDf+nh/2z/7N+2p+n/Xmq/Wl/nvrX9u9o9F/bPwEAAP//AwCEUEYhU2o5rQAAAABJRU5ErkJggg==';
        const BRAND_BLUE = '#002D72';
        const BRAND_YELLOW = '#FFD100';

        const achievements = {
            "velocista": { name: "Velocista", emoji: "‚ö°Ô∏è", description: "Contesta 3 preguntas seguidas en menos de 7 segundos." },
            "precision-absoluta": { name: "Precisi√≥n Absoluta", emoji: "üéØ", description: "Completa un desaf√≠o sin cometer errores." },
            "en-racha": { name: "¬°En Racha!", emoji: "üî•", description: "Logra una racha de 5 aciertos seguidos."}
        };

        // --- APP STATE ---
        const appContainer = document.getElementById('app-container');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let activeGameModule = null;

        // --- SOUND CONTROL ---
        const soundToggleButton = document.getElementById('sound-toggle-button');
        let isMuted = false;
        const iconVolumeOn = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.482 5.482 0 0 1 11.025 8a5.482 5.482 0 0 1-1.61 3.89l.706.706z"/><path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg>`;
        const iconVolumeOff = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06zm7.137 2.096a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 1 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0z"/></svg>`;
        
        const updateSoundButton = () => { soundToggleButton.innerHTML = isMuted ? iconVolumeOff : iconVolumeOn; };
        soundToggleButton.addEventListener('click', () => { 
            if (Tone.context.state !== 'running') { Tone.context.resume(); }
            isMuted = !isMuted; 
            Tone.Master.mute = isMuted; 
            updateSoundButton(); 
        });
        updateSoundButton();
        
        const viewTemplates = {
            login: `
                <div id="login-view" class="w-full max-w-sm text-center">
                    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl">
                        <img src="${LOGO_URL_WEB}" alt="Logo de la Empresa" class="h-10 mx-auto mb-6">
                        <h1 id="login-title" class="text-3xl font-bold" style="color: ${BRAND_YELLOW};">Portal de Desaf√≠os</h1>
                        <p class="text-gray-300 mb-6">Identif√≠cate para continuar.</p>
                        <div id="user-login-fields">
                            <input type="text" id="employee-name-input" placeholder="Nombre Completo" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-cyan-500 transition mb-4">
                            <input type="text" id="employee-id-input" placeholder="N√∫mero de Empleado" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-cyan-500 transition mb-4">
                        </div>
                        <div id="admin-login-fields" class="hidden">
                            <input type="password" id="admin-key-input" placeholder="Clave de Administrador" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600 mb-4">
                        </div>
                        <button data-action="login" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition">Acceder / Registrar</button>
                        <p data-action="admin-toggle" class="text-sm text-cyan-400 mt-4 cursor-pointer hover:underline">¬øEres administrador?</p>
                    </div>
                </div>`,
            profileSetup: `
                <div id="profile-setup-view" class="w-full max-w-lg text-center">
                    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl">
                        <h1 class="text-3xl font-bold" style="color: ${BRAND_YELLOW};">¬°Bienvenido!</h1>
                        <p class="text-gray-300 mb-6">Crea tu perfil para empezar a jugar.</p>
                        <div class="mb-4">
                            <p class="text-gray-400 mb-2">1. Elige tu avatar:</p>
                            <div id="avatar-container" class="flex justify-center gap-2 flex-wrap bg-gray-900/50 p-4 rounded-lg"></div>
                        </div>
                        <div class="mb-6">
                            <p class="text-gray-400 mb-2">2. Elige tu color:</p>
                            <div id="color-container" class="flex justify-center gap-2"></div>
                        </div>
                        <button data-action="save-profile" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg">Guardar y Continuar</button>
                    </div>
                </div>
            `,
            dashboard: `
                <div id="dashboard-view" class="w-full max-w-5xl">
                    <header class="flex justify-between items-center mb-8 flex-wrap gap-4">
                        <div>
                            <h1 class="text-3xl font-bold" style="color: ${BRAND_YELLOW};">Panel de Desaf√≠os</h1>
                            <div class="flex items-center gap-3 mt-2">
                                <span id="dashboard-avatar" class="text-4xl"></span>
                                <p class="text-gray-400 text-xl">Bienvenido, <span id="dashboard-username" class="font-bold text-2xl"></span></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button data-action="show-global-leaderboard" class="font-bold py-2 px-4 rounded-lg transition" style="background-color: ${BRAND_BLUE}; color: ${BRAND_YELLOW};">üèÜ Ranking Global</button>
                            <button data-action="show-profile-editor" class="font-bold py-2 px-4 rounded-lg transition" style="background-color: ${BRAND_BLUE}; color: ${BRAND_YELLOW};">Mi Perfil</button>
                            <button data-action="show-achievements" class="font-bold py-2 px-4 rounded-lg transition" style="background-color: ${BRAND_BLUE}; color: ${BRAND_YELLOW};">Mi Galer√≠a</button>
                            <button data-action="logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Salir</button>
                        </div>
                    </header>
                    <main id="challenge-list" class="grid grid-cols-1 md:grid-cols-2 gap-8"></main>
                </div>`,
            globalLeaderboard: `
                <div id="global-leaderboard-view" class="w-full max-w-2xl">
                    <header class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold" style="color: ${BRAND_YELLOW};">üèÜ Ranking Global</h1>
                        <button data-action="show-dashboard" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">‚Äπ Volver al Panel</button>
                    </header>
                    <main id="global-leaderboard-list" class="bg-gray-800 p-6 rounded-lg space-y-3"></main>
                </div>`,
            achievements: `
                <div id="achievements-view" class="w-full max-w-4xl">
                     <header class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold" style="color: ${BRAND_YELLOW};">Mi Galer√≠a de Logros</h1>
                        <button data-action="show-dashboard" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">‚Äπ Volver al Panel</button>
                    </header>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h2 class="text-xl font-bold text-cyan-400 mb-4">Insignias Ganadas</h2>
                        <main id="badge-gallery" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-8"></main>
                        <h2 class="text-xl font-bold text-cyan-400 mb-4 border-t border-gray-700 pt-6">Certificados Obtenidos</h2>
                        <main id="certificate-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
                    </div>
                </div>`,
            adminDashboard: `
                <div id="admin-dashboard-view" class="w-full max-w-5xl">
                     <header class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-amber-400">Panel de Administrador</h1>
                        <button data-action="logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Salir</button>
                    </header>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <button data-action="show-create-challenge" class="w-full mb-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition">+ Crear Desaf√≠o</button>
                            <button data-action="show-admin-users" class="w-full mb-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition">Supervisar Empleados</button>
                            <button data-action="download-report" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Descargar Reporte (CSV)</button>
                        </div>
                        <main id="admin-main-content" class="md:col-span-2 bg-gray-800 p-6 rounded-lg">
                            <h2 id="admin-content-title" class="text-xl font-semibold mb-4 text-gray-300">Bienvenido, Admin</h2>
                            <div id="admin-content-area">
                                <p class="text-gray-400">Selecciona una opci√≥n del men√∫ para comenzar.</p>
                            </div>
                        </main>
                    </div>
                </div>`
        };

        document.body.addEventListener('click', handleAppClick);

        function handleAppClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            if (activeGameModule && ['create-room', 'join-room', 'back-to-dashboard', 'start-game', 'copy-room-id', 'select-option', 'download-final-certificate', 'play-again'].includes(target.dataset.action)) {
                activeGameModule.handleGameClick(e);
                return;
            }

            const action = target.dataset.action;
            switch(action) {
                case 'login': handleAdminOrUserLogin(); break;
                case 'admin-toggle': toggleAdminView(); break;
                case 'logout': launchPortal(); break;
                case 'show-dashboard': renderDashboard(); break;
                case 'show-achievements': renderAchievements(); break;
                case 'show-profile-editor': renderProfileEditor(); break;
                case 'save-profile': handleSaveProfile(); break;
                case 'launch-challenge': launchChallenge(target.dataset.challengeId); break;
                case 'view-certificate': renderCertificateModal(target.dataset); break;
                case 'close-modal': document.getElementById('generic-modal')?.remove(); break;
                case 'download-modal-pdf': downloadModalPDF(); break;
                case 'show-global-leaderboard': renderGlobalLeaderboard(); break;
                // Admin actions
                case 'show-admin-users': renderAdminUserList(); break;
                case 'view-user-details': getDoc(doc(db, `artifacts/${appId}/public/data/users`, target.dataset.userId)).then(d => d.exists() && renderAdminUserDetail(d.data())); break;
                case 'show-create-challenge': renderCreateChallengeForm(); break;
                case 'generate-questions-ai': handleAIGeneration(); break;
                case 'save-challenge': handleSaveChallenge(); break;
                case 'download-report': downloadUserReportCSV(); break;
            }
        }
        
        function handleAdminOrUserLogin() {
            const isAdmin = document.getElementById('admin-login-fields') && !document.getElementById('admin-login-fields').classList.contains('hidden');
            if (isAdmin) handleAdminLogin(); else handleUserLogin();
        }
        
        async function handleUserLogin() {
            const name = document.getElementById('employee-name-input').value.trim();
            const id = document.getElementById('employee-id-input').value.trim();
            if (!name || !id) {
                alert("Por favor, completa ambos campos.");
                return;
            }
            
            const loginBtn = document.querySelector('[data-action="login"]');
            loginBtn.disabled = true; loginBtn.textContent = 'Accediendo...';
            
            try {
                const userId = id.toLowerCase().replace(/\s+/g, '-');
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                let userDoc = await getDoc(userRef);

                if (!userDoc.exists()) {
                    await setDoc(userRef, { id: userId, name, employeeId: id, createdAt: serverTimestamp(), totalScore: 0, achievements: {} });
                    userDoc = await getDoc(userRef);
                }
                
                currentUser = userDoc.data();
                if (!currentUser.avatar || !currentUser.color) renderProfileEditor(true);
                else renderDashboard();
            } catch (error) {
                console.error("Error de acceso:", error);
                alert("Hubo un error al intentar acceder.");
                loginBtn.disabled = false; loginBtn.textContent = 'Acceder / Registrar';
            }
        }
        
        async function renderDashboard() {
            appContainer.innerHTML = viewTemplates.dashboard;
            const usernameSpan = document.getElementById('dashboard-username');
            const avatarSpan = document.getElementById('dashboard-avatar');
            usernameSpan.textContent = currentUser.name;
            avatarSpan.textContent = currentUser.avatar || 'üë§';
            if (currentUser.color) usernameSpan.style.color = currentUser.color;
            
            const challengeList = document.getElementById('challenge-list');
            challengeList.innerHTML = `<p class="text-gray-400 col-span-full text-center">Cargando...</p>`;
            
            const challengesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/challenges`));
            if (challengesSnapshot.empty) {
                 challengeList.innerHTML = `<p class="text-gray-400 col-span-full text-center">No hay desaf√≠os disponibles. Contacta a un administrador.</p>`;
                 return;
            }

            const completedSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users/${currentUser.id}/certificates`));
            const completedIds = completedSnapshot.docs.map(doc => doc.id);

            challengeList.innerHTML = '';
            challengesSnapshot.forEach(doc => {
                const challenge = { id: doc.id, ...doc.data() };
                const isCompleted = completedIds.includes(challenge.id);
                const card = document.createElement('div');
                card.className = 'challenge-card bg-gray-800 p-6 rounded-2xl cursor-pointer border-t-4 border-gray-700 hover:border-cyan-500';
                card.dataset.action = 'launch-challenge';
                card.dataset.challengeId = challenge.id;
                card.innerHTML = `
                    <div class="challenge-card-inner">
                        <div class="pointer-events-none">
                            <div class="flex items-start gap-4">
                                <span class="text-4xl mt-1">${currentUser.avatar || 'üí°'}</span>
                                <div>
                                    <h2 class="text-xl font-bold text-white">${challenge.title}</h2>
                                    <p class="text-gray-400 text-sm mt-1 h-12 overflow-hidden">${challenge.description}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-4 pointer-events-none">
                            ${isCompleted ? '<span class="bg-green-900 border border-green-700 text-green-300 text-xs font-bold px-3 py-1 rounded-full">COMPLETADO</span>' : '<span></span>'}
                            <span class="bg-cyan-500 text-gray-900 font-bold py-2 px-4 rounded-lg">Jugar ‚Üí</span>
                        </div>
                    </div>`;
                challengeList.appendChild(card);
                
                // Card tilt effect
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const { width, height } = rect;
                    const rotateX = ((y / height) - 0.5) * -20;
                    const rotateY = ((x / width) - 0.5) * 20;
                    card.querySelector('.challenge-card-inner').style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.querySelector('.challenge-card-inner').style.transform = `rotateX(0deg) rotateY(0deg)`;
                });
            });
        }
        
        async function renderGlobalLeaderboard() {
            appContainer.innerHTML = viewTemplates.globalLeaderboard;
            const listEl = document.getElementById('global-leaderboard-list');
            listEl.innerHTML = `<p class="text-gray-400">Cargando ranking...</p>`;

            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, orderBy("totalScore", "desc"), limit(50));
            const usersSnapshot = await getDocs(q);

            if (usersSnapshot.empty) {
                listEl.innerHTML = `<p class="text-gray-400">A√∫n no hay puntajes en el ranking.</p>`;
                return;
            }

            listEl.innerHTML = '';
            usersSnapshot.forEach((doc, index) => {
                const user = doc.data();
                const rank = index + 1;
                let emoji = '';
                if (rank === 1) emoji = 'ü•á';
                else if (rank === 2) emoji = 'ü•à';
                else if (rank === 3) emoji = 'ü•â';
                
                const userElement = document.createElement('div');
                userElement.className = `flex items-center justify-between p-3 rounded-lg ${user.id === currentUser.id ? 'bg-cyan-900 border border-cyan-500' : 'bg-gray-700'}`;
                userElement.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg w-8 text-center">${emoji || rank}</span>
                        <span class="text-3xl">${user.avatar || 'üë§'}</span>
                        <span class="font-semibold text-lg" style="color: ${user.color || '#FFFFFF'};">${user.name}</span>
                    </div>
                    <span class="font-bold text-xl text-amber-400">${user.totalScore || 0} pts</span>
                `;
                listEl.appendChild(userElement);
            });
        }

        function launchPortal() {
            currentUser = null;
            if (activeGameModule) { activeGameModule.cleanup(); activeGameModule = null; }
            appContainer.innerHTML = viewTemplates.login;
        }

        async function launchChallenge(challengeId) {
             const challengeDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/challenges`, challengeId));
             if (!challengeDoc.exists()) {
                 alert("Error: No se pudo encontrar el desaf√≠o.");
                 return;
             }
             activeGameModule = new GameModule(appContainer, { id: challengeId, ...challengeDoc.data() }, currentUser, () => { activeGameModule = null; renderDashboard(); });
             activeGameModule.start();
        }

        class GameModule {
            constructor(container, challenge, user, onFinish) {
                this.container = container; this.challenge = challenge; this.user = user; this.onFinish = onFinish; this.db = db;
                this.currentPlayerId = user.id; this.currentRoomId = null; this.unsubscribeRoom = null; this.unsubscribePlayers = null; this.unsubscribeLeaderboard = null;
                this.timerInterval = null; this.sounds = {}; this.music = {};
                this.mistakesMade = 0; this.fastAnswerStreak = 0; this.correctStreak = 0; this.isSinglePlayer = false; this.confettiAnimationId = null;
                this.handleGameClick = this.handleGameClick.bind(this);
            }
            async start() { this.container.innerHTML = this.getRoomSelectionHTML(); await this.initializeSounds(); }
            cleanup() { if(this.unsubscribeRoom) this.unsubscribeRoom(); if(this.unsubscribePlayers) this.unsubscribePlayers(); if(this.unsubscribeLeaderboard) this.unsubscribeLeaderboard(); if(this.timerInterval) clearInterval(this.timerInterval); if (this.confettiAnimationId) { cancelAnimationFrame(this.confettiAnimationId); this.confettiAnimationId = null; const canvas = document.getElementById('confetti-canvas'); if(canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); } this.stopAllMusic(); }
            handleGameClick(e) { const target = e.target.closest('[data-action]'); if (!target) return; const action = target.dataset.action; switch(action) { case 'create-room': this.createRoom(); break; case 'join-room': this.joinRoom(); break; case 'back-to-dashboard': this.cleanup(); this.onFinish(); break; case 'start-game': this.startGameForEveryone(); break; case 'copy-room-id': const tempInput = document.createElement('textarea'); tempInput.value = this.currentRoomId; document.body.appendChild(tempInput); tempInput.select(); document.execCommand('copy'); document.body.removeChild(tempInput); target.textContent = '¬°Copiado!'; setTimeout(() => target.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>`, 1500); break; case 'select-option': this.checkAnswer(target.dataset.option, target); break; case 'download-final-certificate': this.downloadFinalCertificate(target.dataset.score, target.dataset.rank); break; case 'play-again': this.cleanup(); this.onFinish(); break; } }
            
            async initializeSounds() {
                this.sounds.click = () => new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination().triggerAttackRelease('C5', '8n');
                this.sounds.correct = () => new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination().triggerAttackRelease('G5', '8n');
                this.sounds.incorrect = () => new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.3 } }).toDestination().triggerAttackRelease('A2', '8n');
                this.sounds.tick = () => new Tone.MembraneSynth().toDestination().triggerAttackRelease("C2", "8n");
                this.sounds.achievement = () => new Tone.PolySynth(Tone.Synth).toDestination().triggerAttackRelease(["C4", "E4", "G4", "C5"], "0.5");

                this.music.gameplay = new Tone.Loop(time => { new Tone.Synth().toDestination().triggerAttackRelease("C3", "8n", time); new Tone.Synth().toDestination().triggerAttackRelease("G3", "8n", time + 0.5); }, "1n");
                this.music.victory = new Tone.Pattern(time => { new Tone.Synth().toDestination().triggerAttackRelease("C5", "8n", time); }, ["C5", "E5", "G5", "C6"], "up");
                this.music.victory.interval = "8n";
                
                await Tone.start();
            }
            playSound(sound) { if (this.sounds[sound]) this.sounds[sound](); }
            playGameplayMusic() { this.stopAllMusic(); if (this.music.gameplay) { Tone.Transport.start(); this.music.gameplay.start(0); } }
            playVictoryMusic() { this.stopAllMusic(); if (this.music.victory) { Tone.Transport.start(); this.music.victory.start(0); } }
            stopAllMusic() { Tone.Transport.stop(); if (this.music.gameplay) this.music.gameplay.stop(); if (this.music.victory) this.music.victory.stop(); }

            async createRoom() {
                this.playSound('click');
                this.currentRoomId = Math.random().toString(36).substring(2, 7).toUpperCase();
                const roomPath = `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}`;
                await setDoc(doc(this.db, `${roomPath}/players`, this.currentPlayerId), { name: this.user.name, userId: this.currentPlayerId, isHost: true, avatar: this.user.avatar, color: this.user.color, score: 0, level: 1, completionTimestamp: null });
                await setDoc(doc(this.db, roomPath), { hostId: this.currentPlayerId, status: "waiting", createdAt: serverTimestamp() });
                this.showLobby(true);
            }
            async joinRoom() { this.playSound('click'); const roomId = document.getElementById('room-id-input').value.trim().toUpperCase(); if (!roomId) return alert("Ingresa un c√≥digo de sala."); this.currentRoomId = roomId; const roomPath = `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}`; const roomDoc = await getDoc(doc(this.db, roomPath)); if (!roomDoc.exists() || roomDoc.data().status !== 'waiting') return alert("Sala no v√°lida o la partida ya ha comenzado."); await setDoc(doc(this.db, `${roomPath}/players`, this.currentPlayerId), { name: this.user.name, userId: this.currentPlayerId, isHost: false, avatar: this.user.avatar, color: this.user.color, score: 0, level: 1, completionTimestamp: null }); this.showLobby(false); }
            showLobby(isHost) { this.container.innerHTML = this.getLobbyHTML(); document.getElementById('room-id-display').textContent = this.currentRoomId; if (isHost) document.getElementById('start-game-button').classList.remove('hidden'); else document.getElementById('waiting-for-host').classList.remove('hidden'); this.listenToRoomAndPlayers(); }
            listenToRoomAndPlayers() { const roomPath = `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}`; this.unsubscribePlayers = onSnapshot(query(collection(this.db, `${roomPath}/players`)), (snapshot) => { const lobbyPlayersList = document.getElementById('lobby-players-list'); if (!lobbyPlayersList) { if (this.unsubscribePlayers) this.unsubscribePlayers(); return; } this.isSinglePlayer = snapshot.size === 1; let finishedCount = 0, playerCount = 0; lobbyPlayersList.innerHTML = ''; snapshot.forEach(doc => { playerCount++; const player = doc.data(); const playerDiv = document.createElement('div'); playerDiv.className = 'flex items-center justify-center gap-3 bg-gray-700 p-2 rounded'; playerDiv.innerHTML = `<span class="text-2xl">${player.avatar}</span> <span style="color:${player.color};" class="font-bold">${player.name} ${player.isHost ? 'üëë' : ''}</span>`; lobbyPlayersList.appendChild(playerDiv); if(player.completionTimestamp) finishedCount++; }); if (playerCount > 0 && playerCount === finishedCount) { this.showFinalReport(); } }); this.unsubscribeRoom = onSnapshot(doc(this.db, roomPath), (doc) => { if (doc.exists() && doc.data().status === 'playing') { if (this.unsubscribeRoom) this.unsubscribeRoom(); this.startCountdown(); } }); }
            async startGameForEveryone() { this.playSound('click'); const roomPath = `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}`; const playersSnapshot = await getDocs(collection(this.db, `${roomPath}/players`)); const batch = writeBatch(this.db); playersSnapshot.forEach(playerDoc => { batch.update(doc(this.db, `${roomPath}/players`, playerDoc.id), { level: 1, score: 0, completionTimestamp: null }); }); batch.update(doc(this.db, roomPath), { status: 'playing' }); await batch.commit(); }
            startCountdown() { this.container.innerHTML = this.getCountdownHTML(); let count = 3; document.getElementById('countdown-text').textContent = count; const interval = setInterval(() => { this.playSound('tick'); count--; if (count > 0) document.getElementById('countdown-text').textContent = count; else { clearInterval(interval); this.initGame(); } }, 1000); }
            async initGame() { this.container.innerHTML = this.getGameHTML(); this.playGameplayMusic(); const playerDoc = await getDoc(doc(this.db, `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}/players`, this.currentPlayerId)); const playerData = playerDoc.data(); document.getElementById('player-name').textContent = playerData.name; this.loadLevel(playerData.level || 1, playerData.score || 0); this.setupLeaderboardListener(); }
            loadLevel(level, score) { if(this.timerInterval) clearInterval(this.timerInterval); const levelData = this.challenge.gameData.find(l => l.level === level); if (!levelData) return; this.currentQuestionAttempts = 1; document.getElementById('current-level').textContent = level; document.getElementById('player-score').textContent = score; document.getElementById('challenge-title').textContent = `Nivel ${level}: ${levelData.title}`; document.getElementById('challenge-question').textContent = levelData.question; const optionsContainer = document.getElementById('options-container'); optionsContainer.innerHTML = ''; const shuffledOptions = [...levelData.options].sort(() => Math.random() - 0.5); shuffledOptions.forEach(optionText => { const button = document.createElement('button'); button.textContent = optionText; button.className = 'option-button w-full bg-gray-700 hover:bg-cyan-800 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 border-2 border-transparent'; button.dataset.action = 'select-option'; button.dataset.option = optionText; optionsContainer.appendChild(button); }); document.getElementById('feedback').textContent = ''; this.startTimer(TIME_PER_QUESTION); }
            startTimer(duration) { let remainingTime = duration; const timerBar = document.getElementById('timer-bar'); const timerText = document.getElementById('timer-text'); timerText.textContent = `Tiempo: ${remainingTime}s`; timerBar.style.transition = 'none'; timerBar.style.width = '100%'; setTimeout(() => { if (document.getElementById('timer-bar')) { document.getElementById('timer-bar').style.transition = `width ${duration}s linear`; document.getElementById('timer-bar').style.width = '0%'; } }, 50); this.timerInterval = setInterval(() => { remainingTime--; if (document.getElementById('timer-text')) { document.getElementById('timer-text').textContent = `Tiempo: ${remainingTime}s`; } if (remainingTime < 5 && remainingTime > 0) this.playSound('tick'); if (remainingTime <= 0) { clearInterval(this.timerInterval); this.checkAnswer("", null, true); } }, 1000); }
            setupLeaderboardListener() { const roomPath = `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}`; const q = query(collection(this.db, `${roomPath}/players`), orderBy("score", "desc")); this.unsubscribeLeaderboard = onSnapshot(q, (snapshot) => { const leaderboardEl = document.getElementById('leaderboard'); if (!leaderboardEl) { if (this.unsubscribeLeaderboard) this.unsubscribeLeaderboard(); return; } leaderboardEl.innerHTML = ''; snapshot.forEach((doc, index) => { const player = doc.data(); leaderboardEl.innerHTML += `<li class="flex items-center gap-2 text-sm bg-gray-700 p-2 rounded-lg"><span class="font-bold w-5 text-center">${index + 1}.</span><span class="text-xl">${player.avatar}</span><span class="font-semibold truncate flex-1" style="color: ${player.color};">${player.name}</span><span class="font-bold">${player.score}</span></li>`; }); }); }
            async checkAnswer(selectedAnswer, button, isTimeout = false) { 
                if(this.timerInterval) clearInterval(this.timerInterval);
                const currentLevelEl = document.getElementById('current-level'); if (!currentLevelEl) return;
                this.playSound('click'); 
                const currentLevel = parseInt(currentLevelEl.textContent);
                const levelData = this.challenge.gameData.find(l => l.level === currentLevel); 
                const isCorrect = !isTimeout && selectedAnswer.toLowerCase() === levelData.answer.toLowerCase(); 
                document.querySelectorAll('[data-action="select-option"]').forEach(btn => btn.disabled = true); 
                
                let pointsEarned = 0; 
                if (isCorrect) { 
                    const timerTextEl = document.getElementById('timer-text');
                    const remainingTimeOnCorrect = timerTextEl ? parseInt(timerTextEl.textContent.split(' ')[1] || 0) : 0;
                    if (this.currentQuestionAttempts === 1) pointsEarned = levelData.points + (remainingTimeOnCorrect * 5); 
                    else if (this.currentQuestionAttempts === 2) pointsEarned = Math.floor(levelData.points * 0.5); 
                    else pointsEarned = 10;
                }

                if (isTimeout) { 
                    document.getElementById('feedback').textContent = '¬°Se acab√≥ el tiempo!'; this.playSound('incorrect'); 
                    this.fastAnswerStreak = 0; this.correctStreak = 0; this.mistakesMade++; 
                } else if (isCorrect) { 
                    button.classList.add('correct'); document.getElementById('feedback').textContent = '¬°Correcto!'; this.playSound('correct'); 
                    const pointsFeedbackEl = document.getElementById('points-feedback');
                    if (pointsFeedbackEl) { pointsFeedbackEl.textContent = `+${pointsEarned}`; pointsFeedbackEl.classList.add('points-feedback-animate'); setTimeout(() => pointsFeedbackEl.classList.remove('points-feedback-animate'), 1500); }
                    const remainingTimeOnCorrect = parseInt(document.getElementById('timer-text').textContent.split(' ')[1] || 0); 
                    if (remainingTimeOnCorrect > (TIME_PER_QUESTION - 7)) this.fastAnswerStreak++; else this.fastAnswerStreak = 0; 
                    this.correctStreak++;
                } else { 
                    button.classList.add('incorrect'); document.getElementById('feedback').textContent = 'Incorrecto. ¬°Prueba otra vez!'; this.playSound('incorrect'); 
                    this.fastAnswerStreak = 0; this.correctStreak = 0; this.mistakesMade++; 
                }
                this.updateStreakDisplay();
                const attemptData = { level: currentLevel, question: levelData.question, selectedAnswer: isTimeout ? "TIEMPO AGOTADO" : selectedAnswer, isCorrect, attemptNumber: this.currentQuestionAttempts, timestamp: serverTimestamp() }; 
                await addDoc(collection(this.db, `artifacts/${appId}/public/data/users/${this.user.id}/challenge_attempts/${this.challenge.id}/attempts`), attemptData); 

                if (isCorrect || isTimeout) { 
                    const newLevel = currentLevel + 1; 
                    const playerScoreEl = document.getElementById('player-score');
                    const newScore = (playerScoreEl ? parseInt(playerScoreEl.textContent) : 0) + pointsEarned; 
                    const playerRef = doc(this.db, `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}/players`, this.currentPlayerId); 
                    const isFinishing = !this.challenge.gameData.find(l => l.level === newLevel); 
                    const updateData = { level: newLevel, score: newScore }; 
                    if (isFinishing) updateData.completionTimestamp = serverTimestamp(); 
                    await updateDoc(playerRef, updateData); 
                    await this.checkAndGrantAchievements(); 
                    if (isFinishing) this.showCertificate(newScore); else setTimeout(() => this.loadLevel(newLevel, newScore), 2000); 
                } else { 
                    this.currentQuestionAttempts++; 
                    setTimeout(() => { document.querySelectorAll('[data-action="select-option"]').forEach(btn => { if (!btn.classList.contains('incorrect')) btn.disabled = false; }); this.startTimer(REDUCED_TIME_PER_QUESTION); }, 2000); 
                } 
            }
            async saveCertificate(score) { 
                const certRef = doc(db, `artifacts/${appId}/public/data/users/${this.user.id}/certificates`, this.challenge.id); 
                const docSnap = await getDoc(certRef);
                if (!docSnap.exists() || docSnap.data().score < score) {
                    await setDoc(certRef, { challengeId: this.challenge.id, challengeTitle: this.challenge.title, completedAt: serverTimestamp(), score }, { merge: true });
                    await this.updateUserTotalScore();
                }
            }
            async updateUserTotalScore() {
                const certsRef = collection(db, `artifacts/${appId}/public/data/users/${this.user.id}/certificates`);
                const certsSnapshot = await getDocs(certsRef);
                const totalScore = certsSnapshot.docs.reduce((sum, doc) => sum + (doc.data().score || 0), 0);
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, this.user.id);
                await updateDoc(userRef, { totalScore });
            }
            async showCertificate(score) { 
                await this.saveCertificate(score); 
                const achievementId = `completed-${this.challenge.id}`;
                const achievementRef = doc(db, `artifacts/${appId}/public/data/users/${this.user.id}/achievements`, achievementId);
                if (!(await getDoc(achievementRef)).exists()) {
                    await this.grantAchievement(achievementId, { name: `Maestro de: ${this.challenge.title}`, emoji: 'üèÖ', description: `Completaste el desaf√≠o "${this.challenge.title}".` });
                }
                if (this.isSinglePlayer) this.showFinalReport();
                else this.container.innerHTML = `<div class="text-center"><h2 class="text-2xl font-bold text-cyan-400">¬°Desaf√≠o completado!</h2><p class="text-gray-400">Esperando a los dem√°s jugadores...</p></div>`;
            }
            async showFinalReport() { 
                this.cleanup();
                this.playVictoryMusic();
                this.container.innerHTML = this.getFinalReportHTML(); 
                this.startConfetti(); 
                const playersSnapshot = await getDocs(query(collection(this.db, `artifacts/${appId}/public/data/challenges/${this.challenge.id}/rooms/${this.currentRoomId}/players`), orderBy("score", "desc"))); 
                const players = playersSnapshot.docs.map(doc => doc.data()); 
                const podiumElements = { first: document.getElementById('podium-first'), second: document.getElementById('podium-second'), third: document.getElementById('podium-third') }; 
                let currentUserRank, currentUserScore; 
                players.forEach((player, index) => { 
                    const rank = index + 1; 
                    if (player.userId === this.currentPlayerId) { currentUserRank = rank; currentUserScore = player.score; } 
                    if (rank <= 3) { 
                        let podiumEl, emoji, pedestalHeight, order; 
                        if (rank === 1) { podiumEl = podiumElements.first; emoji = 'üëë'; pedestalHeight = 'h-56'; order = 'order-2'; } 
                        if (rank === 2) { podiumEl = podiumElements.second; emoji = 'ü•à'; pedestalHeight = 'h-48'; order = 'order-1'; } 
                        if (rank === 3) { podiumEl = podiumElements.third; emoji = 'ü•â'; pedestalHeight = 'h-40'; order = 'order-3'; } 
                        podiumEl.classList.add(order);
                        podiumEl.innerHTML = `<div class="text-6xl">${player.avatar}</div><p class="font-bold text-2xl" style="color: ${player.color};">${player.name}</p><p class="text-xl font-semibold text-white">${player.score} pts</p><div class="w-full mt-2 rounded-t-lg ${pedestalHeight}" style="background-color: ${rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : '#CD7F32'}"><p class="text-5xl font-bold text-gray-800 pt-4">${emoji}</p></div>`; 
                    } 
                    document.getElementById('final-rankings-list').innerHTML += `<li class="flex items-center justify-between bg-gray-700 p-3 rounded-lg"><div class="flex items-center gap-3"><span class="font-bold text-lg w-6 text-center">${rank}.</span><span class="text-3xl">${player.avatar}</span><span class="font-semibold text-lg" style="color: ${player.color};">${player.name}</span></div><span class="font-bold text-xl text-amber-400">${player.score} pts</span></li>`; 
                }); 
                const downloadBtn = document.getElementById('download-cert-btn'); 
                if(downloadBtn && currentUserRank !== undefined) { downloadBtn.dataset.rank = currentUserRank; downloadBtn.dataset.score = currentUserScore; downloadBtn.classList.remove('hidden'); } 
            }
            async grantAchievement(achievementKey, achievementData) {
                const achievement = achievementData || achievements[achievementKey];
                if (!achievement) return;
                const achievementRef = doc(db, `artifacts/${appId}/public/data/users/${this.user.id}/achievements`, achievementKey);
                await setDoc(achievementRef, { ...achievement, earnedAt: serverTimestamp() });
                this.showAchievementPopup(achievement);
            }
            showAchievementPopup(achievement) {
                this.playSound('achievement');
                const el = document.getElementById('achievement-unlocked');
                document.getElementById('achievement-emoji').textContent = achievement.emoji;
                document.getElementById('achievement-name').textContent = achievement.name;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 4000);
            }
            async checkAndGrantAchievements(){ 
                const userAchievementsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users/${this.user.id}/achievements`)); 
                const earnedIds = userAchievementsSnapshot.docs.map(doc => doc.id); 
                if (this.fastAnswerStreak >= 3 && !earnedIds.includes('velocista')) this.grantAchievement('velocista');
                if (this.correctStreak >= 5 && !earnedIds.includes('en-racha')) this.grantAchievement('en-racha');
                const currentLevelEl = document.getElementById('current-level');
                if (currentLevelEl) {
                    const nextLevel = parseInt(currentLevelEl.textContent) + 1;
                    const isFinishing = !this.challenge.gameData.find(l => l.level === nextLevel);
                    if (isFinishing && this.mistakesMade === 0 && !earnedIds.includes('precision-absoluta')) this.grantAchievement('precision-absoluta');
                }
            }
            updateStreakDisplay() {
                const streakEl = document.getElementById('streak-display'); if (!streakEl) return;
                if (this.correctStreak >= 2) {
                    streakEl.textContent = `üî• ${this.correctStreak}`;
                    streakEl.classList.add('visible');
                    streakEl.style.animation = 'none';
                    streakEl.offsetHeight; // Trigger reflow
                    streakEl.style.animation = null; 
                } else {
                    streakEl.classList.remove('visible');
                }
            }
            startConfetti() { const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d'); let confetti = []; const confettiCount = 200; canvas.width = window.innerWidth; canvas.height = window.innerHeight; function resetParticle(p) { p.x = Math.random() * canvas.width; p.y = -20; p.r = Math.random() * 6 + 1; p.d = Math.random() * confettiCount; p.color = `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.8)`; p.tilt = Math.random() * 10 - 10; p.tiltAngle = 0; p.tiltAngleIncrement = Math.random() * 0.07 + 0.05; return p; } function draw() { ctx.clearRect(0, 0, canvas.width, canvas.height); for(let i = 0; i < confetti.length; i++) { const p = confetti[i]; ctx.beginPath(); ctx.lineWidth = p.r / 2; ctx.strokeStyle = p.color; ctx.moveTo(p.x + p.tilt + p.r / 4, p.y); ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 4); ctx.stroke(); } update(); this.confettiAnimationId = requestAnimationFrame(draw.bind(this)); } function update() { let remaining = 0; for (let i = 0; i < confetti.length; i++) { const p = confetti[i]; p.tiltAngle += p.tiltAngleIncrement; p.y += (Math.cos(p.d) + 3 + p.r / 2) / 2; p.x += Math.sin(p.d); p.tilt = Math.sin(p.tiltAngle - (i / 3)) * 15; if (p.y <= canvas.height) remaining++; else confetti[i] = resetParticle({}); } if(remaining === 0) { cancelAnimationFrame(this.confettiAnimationId); this.confettiAnimationId = null; ctx.clearRect(0, 0, canvas.width, canvas.height); } } for(let i = 0; i < confettiCount; i++) confetti.push(resetParticle({})); draw.call(this); }
            async downloadFinalCertificate(score, rank) { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' }); doc.setFillColor(BRAND_BLUE); doc.rect(0, 0, 297, 210, 'F'); doc.setTextColor('#FFFFFF'); doc.setFont('helvetica', 'bold'); doc.setFontSize(36); doc.text('CERTIFICADO DE FINALIZACI√ìN', 148.5, 40, { align: 'center' }); doc.setFontSize(20); doc.text('Otorgado a:', 148.5, 70, { align: 'center' }); doc.setFont('helvetica', 'bold'); doc.setFontSize(32); doc.setTextColor(BRAND_YELLOW); doc.text(this.user.name, 148.5, 90, { align: 'center' }); doc.setFont('helvetica', 'normal'); doc.setFontSize(18); doc.setTextColor('#FFFFFF'); doc.text(`Por completar exitosamente el desaf√≠o:`, 148.5, 110, { align: 'center' }); doc.setFont('helvetica', 'bold'); doc.setFontSize(24); doc.text(this.challenge.title, 148.5, 125, { align: 'center' }); doc.setFontSize(16); doc.setTextColor('#FFFFFF'); doc.text(`Puntaje Obtenido: ${score} | Posici√≥n en la Sala: ${rank}`, 148.5, 150, { align: 'center' }); doc.setFontSize(12); doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 148.5, 160, { align: 'center' }); doc.addImage(LOGO_URL_CERTIFICATE, 'PNG', 133.5, 170, 30, 30); doc.save(`certificado-${this.challenge.id}-${this.user.id}.pdf`); }
            getGameHTML() { return `<div id="game-view" class="w-full max-w-4xl relative"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-gray-800 p-8 rounded-2xl shadow-2xl relative"><div id="points-feedback" class="absolute top-1/2 left-1/2 text-6xl font-black text-green-400 opacity-0 pointer-events-none" style="text-shadow: 0 0 10px rgba(0,255,0,0.7);"></div><div class="mb-4"><div class="flex justify-between items-center text-lg mb-2"><span id="timer-text" class="font-bold text-cyan-400"></span><span class="font-bold" style="color: ${BRAND_YELLOW};">Nivel <span id="current-level">1</span>/${this.challenge.gameData.length}</span></div><div class="timer-bar-container"><div id="timer-bar" class="timer-bar"></div></div></div><div id="game-content" class="bg-gray-900 p-6 rounded-lg min-h-[200px] flex flex-col justify-center"><h3 class="text-xl font-bold mb-4" id="challenge-title"></h3><p class="text-gray-300 text-lg" id="challenge-question"></p></div><div id="options-container" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4"></div><p id="feedback" class="mt-4 text-center font-semibold h-6"></p></div><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl relative"><div id="streak-display" class="absolute -top-4 -right-4 text-6xl opacity-0 transform" style="text-shadow: 0 0 15px #f59e0b, 0 0 5px #ef4444;"></div><div class="flex justify-between items-center mb-6"><div><h2 class="text-xl font-semibold">Jugador:</h2><p id="player-name" class="text-2xl font-bold" style="color: ${this.user.color};"></p></div><div><h2 class="text-xl font-semibold text-right">Puntaje:</h2><p id="player-score" class="font-bold text-2xl text-green-400 text-right">0</p></div></div><h3 class="text-2xl font-bold text-center mb-4" style="color: ${BRAND_YELLOW};">üèÜ Ranking en Vivo üèÜ</h3><ol id="leaderboard" class="space-y-3"></ol></div></div></div>`; }
            getFinalReportHTML() { return `<div id="final-report-view" class="w-full max-w-4xl text-center"><h1 class="text-5xl font-bold" style="color: ${BRAND_YELLOW};">¬°Partida Finalizada!</h1><div class="flex justify-center items-end gap-4 my-12 h-64"><div id="podium-second" class="podium-item flex flex-col items-center justify-end w-1/4"></div><div id="podium-first" class="podium-item flex flex-col items-center justify-end w-1/3"></div><div id="podium-third" class="podium-item flex flex-col items-center justify-end w-1/4"></div></div><div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-4" style="color: ${BRAND_YELLOW};">Ranking Final de la Sala</h2><ol id="final-rankings-list" class="space-y-2"></ol></div><div class="mt-8 flex justify-center gap-4"><button data-action="play-again" class="font-bold py-3 px-6 rounded-lg transition" style="background-color: ${BRAND_YELLOW}; color: ${BRAND_BLUE};">Volver al Panel</button><button id="download-cert-btn" data-action="download-final-certificate" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition">Descargar Certificado (PDF)</button></div></div>`; }
            getRoomSelectionHTML() { return `<div id="room-selection-view" class="w-full max-w-lg text-center"><button data-action="back-to-dashboard" class="absolute top-4 left-4 bg-gray-600 hover:bg-gray-700 p-2 rounded-full text-white">‚Äπ</button><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl"><h1 class="text-3xl font-bold" style="color: ${BRAND_YELLOW};">${this.challenge.title}</h1><p class="text-gray-300 mb-6">Prep√°rate para el desaf√≠o. ¬°Buena suerte!</p><button data-action="create-room" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg mb-4">Crear Sala (Jugar Solo o en Grupo)</button><div class="flex items-center space-x-2"><input type="text" id="room-id-input" placeholder="C√≥digo de la sala" class="w-2/3 bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600"><button data-action="join-room" class="w-1/3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Unirse</button></div></div></div>`; }
            getLobbyHTML() { return `<div id="lobby-view" class="w-full max-w-lg text-center"><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl"><p class="text-gray-400">C√≥digo de la Sala:</p><div class="flex justify-center items-center gap-2 my-2"><h2 id="room-id-display" class="text-4xl font-bold" style="color: ${BRAND_YELLOW};"></h2><button data-action="copy-room-id" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg" title="Copiar c√≥digo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg></button></div><p class="text-cyan-400 mb-6">Comparte este c√≥digo para que otros se unan.</p><h3 class="text-xl font-semibold mb-4">Jugadores en la sala:</h3><div id="lobby-players-list" class="space-y-2 min-h-[100px] bg-gray-900 p-4 rounded-lg"></div><button id="start-game-button" data-action="start-game" class="hidden mt-6 w-full font-bold py-3 px-4 rounded-lg" style="background-color: ${BRAND_YELLOW}; color: ${BRAND_BLUE};">¬°Comenzar Juego!</button><p id="waiting-for-host" class="hidden mt-6 text-gray-400">Esperando que el anfitri√≥n inicie el juego...</p></div></div>`; }
            getCountdownHTML() { return `<div id="countdown-overlay" class="fixed inset-0 bg-gray-900/90 flex items-center justify-center z-50"><h1 id="countdown-text" class="text-9xl font-bold" style="color: ${BRAND_YELLOW};"></h1></div>`; }
        }
        
        function toggleAdminView() {
            const userFields = document.getElementById('user-login-fields');
            const adminFields = document.getElementById('admin-login-fields');
            const title = document.getElementById('login-title');
            const toggleLink = document.querySelector('[data-action="admin-toggle"]');
            const loginButton = document.querySelector('[data-action="login"]');
            
            if (adminFields.classList.contains('hidden')) {
                userFields.classList.add('hidden');
                adminFields.classList.remove('hidden');
                title.textContent = 'Acceso de Administrador';
                toggleLink.textContent = '¬øNo eres administrador?';
                loginButton.textContent = 'Acceder';
            } else {
                userFields.classList.remove('hidden');
                adminFields.classList.add('hidden');
                title.textContent = 'Portal de Desaf√≠os';
                toggleLink.textContent = '¬øEres administrador?';
                loginButton.textContent = 'Acceder / Registrar';
            }
        }

        function handleAdminLogin() {
            const keyInput = document.getElementById('admin-key-input');
            if (keyInput.value === '1234') {
                currentUser = { id: 'admin', name: 'Admin', isAdmin: true };
                renderAdminDashboard();
            } else {
                alert('Clave de administrador incorrecta.');
            }
        }
        
        function renderProfileEditor(isFirstTime = false) {
            appContainer.innerHTML = viewTemplates.profileSetup;
            const avatarContainer = document.getElementById('avatar-container');
            const colorContainer = document.getElementById('color-container');

            AVATARS.forEach(avatar => {
                const div = document.createElement('div');
                div.className = `avatar-selector text-4xl p-2 ${currentUser?.avatar === avatar ? 'selected' : ''}`;
                div.textContent = avatar;
                div.onclick = () => {
                    document.querySelectorAll('.avatar-selector').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                };
                avatarContainer.appendChild(div);
            });
            
            COLORS.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-selector ${currentUser?.color === color ? 'selected' : ''}`;
                div.style.backgroundColor = color;
                div.onclick = () => {
                    document.querySelectorAll('.color-selector').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                };
                colorContainer.appendChild(div);
            });
        }
        
        async function handleSaveProfile() {
            const selectedAvatar = document.querySelector('.avatar-selector.selected')?.textContent;
            const selectedColor = document.querySelector('.color-selector.selected')?.style.backgroundColor;
            if (!selectedAvatar || !selectedColor) {
                alert('Por favor, elige un avatar y un color.');
                return;
            }
            const colorRgb = selectedColor.match(/\d+/g);
            const colorHex = '#' + ((1 << 24) + (+colorRgb[0] << 16) + (+colorRgb[1] << 8) + +colorRgb[2]).toString(16).slice(1);

            const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.id);
            await updateDoc(userRef, { avatar: selectedAvatar, color: colorHex });
            currentUser.avatar = selectedAvatar;
            currentUser.color = colorHex;
            renderDashboard();
        }
        
        async function renderAchievements() {
            appContainer.innerHTML = viewTemplates.achievements;
            const badgeGallery = document.getElementById('badge-gallery');
            const certificateGallery = document.getElementById('certificate-gallery');
            badgeGallery.innerHTML = '<p class="text-gray-400 col-span-full">Cargando insignias...</p>';
            certificateGallery.innerHTML = '<p class="text-gray-400 col-span-full">Cargando certificados...</p>';

            const achievementsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users/${currentUser.id}/achievements`));
            if(achievementsSnapshot.empty) {
                badgeGallery.innerHTML = '<p class="text-gray-400 col-span-full">A√∫n no has ganado insignias.</p>';
            } else {
                badgeGallery.innerHTML = '';
                achievementsSnapshot.forEach(doc => {
                    const ach = doc.data();
                    badgeGallery.innerHTML += `<div class="bg-gray-700 p-4 rounded-lg text-center" title="${ach.description}"><div class="text-5xl mb-2">${ach.emoji}</div><p class="font-bold">${ach.name}</p></div>`;
                });
            }

            const certificatesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users/${currentUser.id}/certificates`));
            if(certificatesSnapshot.empty) {
                certificateGallery.innerHTML = '<p class="text-gray-400 col-span-full">A√∫n no has obtenido certificados.</p>';
            } else {
                certificateGallery.innerHTML = '';
                certificatesSnapshot.forEach(doc => {
                    const cert = doc.data();
                    certificateGallery.innerHTML += getArchivedCertificateHTML({
                        username: currentUser.name,
                        challengeTitle: cert.challengeTitle,
                        score: cert.score,
                        date: cert.completedAt.toDate().toLocaleDateString('es-ES')
                    });
                });
            }
        }
        
        function getArchivedCertificateHTML(data) {
            return `
            <div class="certificate-gallery-item bg-gray-700 p-4 rounded-lg cursor-pointer flex flex-col items-center justify-center text-center"
                 data-action="view-certificate"
                 data-username="${data.username}"
                 data-challenge-title="${data.challengeTitle}"
                 data-score="${data.score || ''}"
                 data-completed-at="${data.date}">
                <div class="text-5xl mb-2 pointer-events-none">üìú</div>
                <p class="font-bold text-amber-400 pointer-events-none">${data.challengeTitle}</p>
                <p class="text-sm text-gray-300 pointer-events-none">Completado: ${data.date}</p>
            </div>`;
        }
        
        // --- CERTIFICATE MODAL (OLD VERSION RESTORED) ---
        function renderCertificateModal(data) {
            const modal = document.createElement('div');
            modal.id = 'generic-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center p-4 z-40';
            
            const certificateHTML = `
                <div id="certificate-content" class="bg-white text-gray-800 p-10 rounded-lg shadow-2xl text-center max-w-2xl w-full" style="border: 8px solid ${BRAND_BLUE};">
                    <img src="${LOGO_URL_CERTIFICATE}" alt="Logo de la Empresa" class="mx-auto h-12 mb-4" crossorigin="anonymous">
                    <h2 class="text-4xl font-bold text-gray-700 mb-2" style="font-family: 'Times New Roman', serif;">Certificado de Finalizaci√≥n</h2>
                    <div class="w-1/3 h-1 mx-auto mb-4" style="background-color: ${BRAND_YELLOW};"></div>
                    <p class="text-lg text-gray-500 mb-4">Otorgado a:</p>
                    <p class="text-5xl font-bold mb-4" style="font-family: 'Brush Script MT', cursive; color: ${BRAND_BLUE};">${data.username}</p>
                    <p class="text-gray-600 mb-4">Por completar exitosamente la capacitaci√≥n interactiva:</p>
                    <p class="text-xl font-semibold text-gray-800 mb-8">"${data.challengeTitle}"</p>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-gray-500">${data.completedAt}</p>
                        <p class="text-sm font-bold" style="color: ${BRAND_BLUE};">Portal de Desaf√≠os</p>
                    </div>
                </div>
                <div class="mt-4 flex gap-4">
                    <button data-action="download-modal-pdf" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition">Descargar (PDF)</button>
                    <button data-action="close-modal" class="font-bold py-2 px-6 rounded-lg transition" style="background-color: ${BRAND_BLUE}; color: ${BRAND_YELLOW};">Cerrar</button>
                </div>
            `;
            modal.innerHTML = certificateHTML;
            document.body.appendChild(modal);
        }

        function downloadModalPDF() {
            const certificateElement = document.querySelector("#generic-modal #certificate-content");
            if (!certificateElement) return;

            const { jsPDF } = window.jspdf;
            html2canvas(certificateElement, { useCORS: true, scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`certificado.pdf`);
            });
        }
        
        // --- ADMIN FUNCTIONS (FULLY IMPLEMENTED) ---
        async function renderAdminDashboard() { 
            appContainer.innerHTML = viewTemplates.adminDashboard; 
        }

        async function renderAdminUserList() {
            const contentArea = document.getElementById('admin-content-area');
            const contentTitle = document.getElementById('admin-content-title');
            contentTitle.textContent = "Perfiles de Empleados";
            contentArea.innerHTML = `<p class="text-gray-400">Cargando usuarios...</p>`;
            const usersSnapshot = await getDocs(query(collection(db, `artifacts/${appId}/public/data/users`), orderBy("name")));
            if (usersSnapshot.empty) {
                contentArea.innerHTML = `<p class="text-gray-400">No hay usuarios registrados.</p>`;
                return;
            }
            contentArea.innerHTML = '<div class="space-y-3"></div>';
            const userListContainer = contentArea.querySelector('div');
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userElement = document.createElement('div');
                userElement.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-600';
                userElement.dataset.action = 'view-user-details';
                userElement.dataset.userId = user.id;
                userElement.innerHTML = `<div class="pointer-events-none"><p class="font-semibold">${user.name}</p><p class="text-sm text-gray-400">ID: ${user.employeeId}</p></div><span class="text-cyan-400 pointer-events-none">Ver Detalles ‚Ä∫</span>`;
                userListContainer.appendChild(userElement);
            });
        }

        async function renderAdminUserDetail(user) {
            const contentArea = document.getElementById('admin-content-area');
            const contentTitle = document.getElementById('admin-content-title');
            contentTitle.innerHTML = `Detalle de: <span class="text-amber-400">${user.name}</span>`;
            contentArea.innerHTML = `<p class="text-gray-400">Cargando progreso...</p>`;

            const challengesRef = collection(db, `artifacts/${appId}/public/data/challenges`);
            const challengesSnapshot = await getDocs(challengesRef);

            const certificatesRef = collection(db, `artifacts/${appId}/public/data/users/${user.id}/certificates`);
            const completedSnapshot = await getDocs(certificatesRef);
            const completedIds = completedSnapshot.docs.map(doc => doc.id);

            let contentHTML = '<div class="space-y-4">';
            for (const challengeDoc of challengesSnapshot.docs) {
                const challengeId = challengeDoc.id;
                const challenge = challengeDoc.data();
                const isCompleted = completedIds.includes(challengeId);
                
                contentHTML += `<div class="bg-gray-700 p-4 rounded-lg"><div class="flex justify-between items-center"><h4 class="text-lg font-semibold">${challenge.title}</h4>${isCompleted ? `<span class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">COMPLETADO</span>` : `<span class="bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded-full">PENDIENTE</span>`}</div>`;

                if (isCompleted) {
                    const attemptsRef = collection(db, `artifacts/${appId}/public/data/users/${user.id}/challenge_attempts/${challengeId}/attempts`);
                    const attemptsSnapshot = await getDocs(query(attemptsRef, orderBy("timestamp")));
                    if (!attemptsSnapshot.empty) {
                        contentHTML += `<div class="mt-4 border-t border-gray-600 pt-3 text-sm space-y-2">`;
                        let questionAttempts = {};
                        attemptsSnapshot.forEach(attemptDoc => {
                            const attempt = attemptDoc.data();
                            if(!questionAttempts[attempt.level]) questionAttempts[attempt.level] = [];
                            questionAttempts[attempt.level].push(attempt);
                        });

                        Object.keys(questionAttempts).sort((a,b) => a-b).forEach(level => {
                            const attempts = questionAttempts[level];
                            const firstTryCorrect = attempts.find(a => a.attemptNumber === 1 && a.isCorrect);
                            const questionData = challenge.gameData.find(q => q.level == level);
                            const questionText = questionData ? questionData.question : 'Pregunta no encontrada';
                            
                            contentHTML += `
                                <div class="p-2 rounded-md ${firstTryCorrect ? 'bg-green-900/50' : 'bg-red-900/50'}">
                                    <p class="font-semibold text-gray-300">Pregunta ${level}: <span class="font-normal italic">"${questionText}"</span></p>
                                    <p class="mt-1"><strong>Resultado:</strong> ${firstTryCorrect ? 'Correcto al primer intento' : 'Necesit√≥ m√°s de un intento'} </p>
                                </div>`;
                        });
                        contentHTML += `</div>`;
                    }
                }
                contentHTML += `</div>`;
            }
            contentHTML += '</div>';
            contentArea.innerHTML = contentHTML;
        }
        
        function renderCreateChallengeForm(generatedData = null) {
            const contentArea = document.getElementById('admin-content-area');
            const contentTitle = document.getElementById('admin-content-title');
            contentTitle.textContent = "Crear Nuevo Desaf√≠o con IA";
            
            let questionsHTML = '';
            if (generatedData && generatedData.gameData) {
                generatedData.gameData.forEach((q, index) => {
                    questionsHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg mt-4" data-question-index="${index}">
                            <label class="block text-sm font-medium text-gray-300">Pregunta ${index + 1}</label>
                            <input type="text" value="${q.question}" class="mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500" data-field="question">
                            
                            <label class="block text-sm font-medium text-gray-300 mt-3">Opciones y Respuesta Correcta</label>
                            <div class="mt-2 space-y-2">
                                ${q.options.map((opt, optIndex) => `
                                    <div class="flex items-center">
                                        <input type="radio" name="correct-answer-${index}" ${opt === q.answer ? 'checked' : ''} value="${opt}" class="focus:ring-amber-500 h-4 w-4 text-amber-600 border-gray-500 bg-gray-600">
                                        <input type="text" value="${opt}" class="ml-3 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500" data-field="option-${optIndex}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }

            contentArea.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label for="challenge-title-input" class="block text-sm font-medium text-gray-300">T√≠tulo del Desaf√≠o</label>
                        <input type="text" id="challenge-title-input" class="mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500" value="${generatedData?.title || ''}">
                    </div>
                    <div>
                        <label for="challenge-desc-input" class="block text-sm font-medium text-gray-300">Descripci√≥n</label>
                        <input type="text" id="challenge-desc-input" class="mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500" value="${generatedData?.description || ''}">
                    </div>
                    
                    <div id="ai-generation-panel" class="${generatedData ? 'hidden' : ''}">
                        <div>
                            <label for="question-count" class="block text-sm font-medium text-gray-300">N√∫mero de Preguntas</label>
                            <select id="question-count" class="mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                                <option>5</option>
                                <option selected>10</option>
                                <option>12</option>
                                <option>15</option>
                            </select>
                        </div>

                        <div class="mt-4">
                            <label for="ai-context" class="block text-sm font-medium text-gray-300">Pega el contenido del documento aqu√≠</label>
                            <textarea id="ai-context" rows="10" class="mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="Pega el texto de tu PDF o Word..."></textarea>
                        </div>
                        <button data-action="generate-questions-ai" class="mt-4 w-full bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition">
                            <span id="generate-btn-text">‚ú® Generar Preguntas con IA</span>
                            <span id="generate-spinner" class="hidden">Generando...</span>
                        </button>
                    </div>

                    <div id="generated-questions-container">
                        ${questionsHTML}
                    </div>

                    <button data-action="save-challenge" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition ${!generatedData ? 'hidden' : ''}">
                        Guardar Desaf√≠o
                    </button>
                </div>
            `;
        }
        
        async function handleAIGeneration() {
            const contextArea = document.getElementById('ai-context');
            const countSelect = document.getElementById('question-count');
            const genButton = document.querySelector('[data-action="generate-questions-ai"]');
            const btnText = document.getElementById('generate-btn-text');
            const spinner = document.getElementById('generate-spinner');

            if (!contextArea.value.trim()) {
                alert("Por favor, pega el contenido para la IA.");
                return;
            }

            genButton.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');

            const systemPrompt = "Eres un experto creando cuestionarios de opci√≥n m√∫ltiple para capacitaciones corporativas. Basado en el texto proporcionado, genera un n√∫mero espec√≠fico de preguntas. Cada pregunta debe tener una respuesta correcta y tres opciones incorrectas plausibles. La respuesta siempre debe estar incluida en las opciones. Devuelve el resultado en el formato JSON especificado.";
            const userPrompt = `Texto base:\n\n${contextArea.value}\n\nPor favor, genera un desaf√≠o de ${countSelect.value} preguntas de este texto. El desaf√≠o debe tener un t√≠tulo y descripci√≥n creativa.`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "title": { "type": "STRING" },
                            "description": { "type": "STRING" },
                            "gameData": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "level": { "type": "NUMBER" },
                                        "title": { "type": "STRING" },
                                        "question": { "type": "STRING" },
                                        "answer": { "type": "STRING" },
                                        "options": {
                                            type: "ARRAY",
                                            items: { "type": "STRING" }
                                        },
                                        "points": { "type": "NUMBER" }
                                    },
                                    required: ["level", "title", "question", "answer", "options", "points"]
                                }
                            }
                        },
                        required: ["title", "description", "gameData"]
                    }
                }
            };
            
            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error de API: ${response.statusText}`);
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                const generatedData = JSON.parse(jsonText);
                
                generatedData.gameData.forEach((q, i) => { q.level = i + 1; q.points = 100; });
                renderCreateChallengeForm(generatedData);

            } catch (error) {
                console.error("Error al generar con IA:", error);
                alert("Hubo un error al generar las preguntas. Por favor, intenta de nuevo.");
            } finally {
                genButton.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        async function handleSaveChallenge() {
            const title = document.getElementById('challenge-title-input').value.trim();
            const description = document.getElementById('challenge-desc-input').value.trim();
            if (!title || !description) return alert("El t√≠tulo y la descripci√≥n no pueden estar vac√≠os.");

            const gameData = [];
            const questionElements = document.querySelectorAll('#generated-questions-container > div');
            
            for (const el of questionElements) {
                const index = parseInt(el.dataset.questionIndex, 10);
                const question = el.querySelector('[data-field="question"]').value;
                const options = Array.from(el.querySelectorAll('[data-field^="option-"]')).map(opt => opt.value);
                const answerRadio = el.querySelector(`input[name="correct-answer-${index}"]:checked`);
                
                if (!question || options.some(o => !o) || !answerRadio) return alert(`Por favor, completa todos los campos y selecciona una respuesta para la pregunta ${index + 1}.`);
                
                gameData.push({ level: index + 1, title: `Pregunta ${index + 1}`, question, options, answer: answerRadio.value, points: 100 });
            }

            const challengeId = title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            const challengeRef = doc(db, `artifacts/${appId}/public/data/challenges`, challengeId);

            try {
                await setDoc(challengeRef, { title, description, gameData });
                alert("¬°Desaf√≠o guardado exitosamente!");
                renderAdminDashboard();
            } catch (error) {
                console.error("Error al guardar el desaf√≠o:", error);
                alert("No se pudo guardar el desaf√≠o.");
            }
        }
        
        async function downloadUserReportCSV() {
            const challengesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/challenges`));
            const challenges = challengesSnapshot.docs.map(doc => ({ id: doc.id, title: doc.data().title }));
            const usersSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users`));
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += ["ID Empleado", "Nombre", ...challenges.map(c => c.title)].join(",") + "\r\n";

            for (const userDoc of usersSnapshot.docs) {
                const user = userDoc.data();
                const row = [user.employeeId, user.name];
                const completedSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/users/${user.id}/certificates`));
                const completedIds = completedSnapshot.docs.map(doc => doc.id);
                for (const challenge of challenges) {
                    row.push(completedIds.includes(challenge.id) ? "Completado" : "Pendiente");
                }
                csvContent += row.join(",") + "\r\n";
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "reporte_desafios.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function setupInitialChallenges() {
            const challengesRef = collection(db, `artifacts/${appId}/public/data/challenges`);
            const docSnap = await getDocs(challengesRef);
            if (docSnap.empty) {
                console.log("No initial challenges found. Seeding database with correct challenge...");
                const challengeId = 'quejas-v1';
                const challengeData = {
                    title: "Dominio de Quejas", 
                    description: "Demuestra tu conocimiento sobre el proceso de escalamiento de quejas.", 
                    gameData: [ 
                        { level: 1, title: "Canales de Entrada", question: "¬øCu√°l NO es un canal oficial para recibir quejas?", answer: "WhatsApp", options: ["WhatsApp", "Facebook", "App M√≥vil", "Oficios CONDUSEF"], points: 100 }, 
                        { level: 2, title: "El Primer Contacto", question: "Una queja es una 'Expresi√≥n de...'", answer: "Insatisfacci√≥n", options: ["Insatisfacci√≥n", "Duda", "Agradecimiento", "Sugerencia"], points: 100 }, 
                        { level: 3, title: "El Filtro Inicial", question: "Si un folio es una consulta, debe ser...", answer: "Re-tipificado", options: ["Re-tipificado", "Cerrado", "Escalado", "Archivado"], points: 100 }, 
                        { level: 4, title: "Faltas Graves", question: "Prestar tu n√∫mero de promotor es una...", answer: "Falta Grave", options: ["Falta Grave", "Falta Leve", "Llamada de atenci√≥n", "Pr√°ctica com√∫n"], points: 100 }, 
                        { level: 5, title: "An√°lisis del Caso", question: "¬øCu√°l es el primer paso del procedimiento?", answer: "An√°lisis del caso", options: ["An√°lisis del caso", "Llamar al cliente", "Agendar cita", "Enviar correo"], points: 100 }, 
                        { level: 6, title: "Comunicaci√≥n", question: "Si no hay contacto telef√≥nico, el folio pasa a estatus...", answer: "Pendiente Cliente", options: ["Pendiente Cliente", "Resuelto", "En Proceso", "Cancelado"], points: 100 }, 
                        { level: 7, title: "Notificaci√≥n Interna", question: "El correo de notificaci√≥n se env√≠a al Coordinador Regional y en CC a su...", answer: "Gerente Comercial", options: ["Gerente Comercial", "Subdirector Comercial", "Asesor Previsional", "Director General"], points: 100 }, 
                        { level: 8, title: "Protocolo Especial", question: "En queja de adulto mayor, ¬øa qu√© Gerencia se copia?", answer: "Gerencia de Pensiones", options: ["Gerencia de Pensiones", "Unidad Especializada", "Gerencia de Oficios", "Recursos Humanos"], points: 100 }, 
                        { level: 9, title: "Cierre del Ciclo", question: "El √∫ltimo paso del proceso es...", answer: "Cierre del Folio CRM", options: ["Cierre del Folio CRM", "Monitoreo del Servicio", "Llamada de seguimiento", "Enviar encuesta"], points: 100 }, 
                        { level: 10, title: "Di√°logo Correcto", question: "En la disculpa, si no es suficiente, se ofrece...", answer: "Agendar nueva cita", options: ["Agendar nueva cita", "Un descuento", "Un bono", "Cancelar el tr√°mite"], points: 100 }
                    ]
                };
                await setDoc(doc(db, `artifacts/${appId}/public/data/challenges`, challengeId), challengeData);
                console.log('Correct initial challenge ("Dominio de Quejas") created.');
            }
        }
        
        const startApp = async () => {
            try {
                // Simplified authentication: Always use anonymous sign-in.
                // The app's own user logic (employee ID) will handle identity.
                if (auth.currentUser === null) {
                     await signInAnonymously(auth);
                }
                
                await setupInitialChallenges();
                launchPortal();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                appContainer.innerHTML = `<div class="bg-red-900 border border-red-500 text-red-300 p-4 rounded-lg text-center">
                    <h2 class="font-bold text-lg">Se ha producido un error de conexi√≥n</h2>
                    <p>No se pudo inicializar la aplicaci√≥n. Por favor, intenta recargar la p√°gina.</p>
                    <p class="text-xs mt-2 text-red-400">Detalle: ${error.message}</p>
                </div>`;
            }
        };

        // --- INITIALIZATION ---
        startApp();
    </script>
</body>
</html>





